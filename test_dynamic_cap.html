<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PathBåŠ¨æ€ä¸Šé™æµ‹è¯•</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .test-card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        h1 {
            color: #764ba2;
            margin-bottom: 10px;
        }
        .subtitle {
            color: #888;
            margin-bottom: 30px;
        }
        button {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            opacity: 0.9;
        }
        .result {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin-top: 20px;
            border-radius: 4px;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 500px;
            overflow-y: auto;
        }
        .success { border-left-color: #28a745; }
        .error { border-left-color: #dc3545; }
        .warning { border-left-color: #ffc107; }
        .test-case {
            background: #f0f4ff;
            padding: 15px;
            margin: 10px 0;
            border-radius: 6px;
            border: 1px solid #d0d7de;
        }
        .test-case h4 {
            margin-top: 0;
            color: #667eea;
        }
        .label {
            font-weight: bold;
            color: #555;
        }
    </style>
</head>
<body>
    <div class="test-card">
        <h1>ğŸ§ª PathBåŠ¨æ€ä¸Šé™æµ‹è¯•</h1>
        <p class="subtitle">éªŒè¯åç«¯APIé›†æˆåŠ¨æ€ä¸Šé™è®¡ç®—ï¼ˆæ›¿ä»£å›ºå®š12,000ï¼‰</p>
        
        <div>
            <button onclick="testCase1()">æµ‹è¯•1: 24ä¸‡å¹´è–ª + 1.5ä¸‡ç¼´è´¹</button>
            <button onclick="testCase2()">æµ‹è¯•2: 20ä¸‡å¹´è–ª + 1.2ä¸‡ç¼´è´¹</button>
            <button onclick="testCase3()">æµ‹è¯•3: è¶…é™ç¼´è´¹ï¼ˆ3ä¸‡ï¼‰</button>
            <button onclick="testCapCalculator()">æµ‹è¯•4: ç›´æ¥è°ƒç”¨ä¸Šé™è®¡ç®—å™¨</button>
        </div>
        
        <div id="result" class="result" style="display:none;"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000/api';

        function displayResult(content, type = 'info') {
            const resultDiv = document.getElementById('result');
            resultDiv.className = `result ${type}`;
            resultDiv.textContent = content;
            resultDiv.style.display = 'block';
        }

        // æµ‹è¯•æ¡ˆä¾‹1: ç”¨æˆ·åŸå§‹é—®é¢˜ï¼ˆ24ä¸‡å¹´è–ªï¼Œç¼´è´¹1.5ä¸‡ï¼‰
        async function testCase1() {
            displayResult('â³ æ­£åœ¨æµ‹è¯•...');
            try {
                const response = await fetch(`${API_BASE}/history/diagnose`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        history: [
                            { year: 2022, salary: 200000, contribution: 12000 },
                            { year: 2023, salary: 220000, contribution: 12000 },
                            { year: 2024, salary: 240000, contribution: 15000 }
                        ],
                        age: 27
                    })
                });

                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                
                let output = 'âœ… æµ‹è¯•æ¡ˆä¾‹1: 24ä¸‡å¹´è–ª + 1.5ä¸‡ç¼´è´¹\n\n';
                output += `ã€è¯Šæ–­ç»“æœã€‘\n`;
                output += `  ç´¯ç§¯T2: ${data.cumulativeT2}%\n`;
                output += `  æ•ˆç‡è¯„åˆ†: ${data.efficiencyScore}åˆ†\n`;
                output += `  æ¨èç¼´è´¹é¢: Â¥${data.recommendedAmount.toLocaleString()}/å¹´\n`;
                output += `  é¢„æµ‹T3: ${data.predictedT3}%\n\n`;
                
                output += `ã€åŠ¨æ€ä¸Šé™æ£€æµ‹ã€‘\n`;
                if (data.diagnosis.exceedsDynamicCap) {
                    output += `  âš ï¸ è¶…å‡ºåŠ¨æ€ä¸Šé™\n`;
                    output += `  è¶…é™è®°å½•: ${data.diagnosis.capWarnings.length}æ¡\n`;
                    data.diagnosis.capWarnings.forEach(w => {
                        output += `    ${w.year}å¹´: ç¼´è´¹Â¥${w.contribution.toLocaleString()} > `
                               + `ä¸Šé™Â¥${w.dynamic_cap.toLocaleString()}, è¶…å‡ºÂ¥${w.excess.toLocaleString()}\n`;
                    });
                } else {
                    output += `  âœ… æœªè¶…å‡ºåŠ¨æ€ä¸Šé™\n`;
                }
                
                output += `\nã€å…³é”®éªŒè¯ã€‘\n`;
                output += `  â“ 1.5ä¸‡ç¼´è´¹æ˜¯å¦åˆç†ï¼Ÿ\n`;
                output += `  ç­”ï¼š${!data.diagnosis.exceedsDynamicCap ? 'âœ… åˆç†' : 'âŒ è¶…é™'}`;
                output += `ï¼ˆåŠ¨æ€ä¸Šé™æ¨¡å‹å…è®¸é«˜T2+é«˜æ”¶å…¥ç»„åˆä¸‹è¶…è¿‡12kï¼‰\n\n`;
                
                output += `ã€è¯Šæ–­æ¶ˆæ¯ã€‘\n  ${data.diagnosis.message}`;
                
                displayResult(output, data.diagnosis.exceedsDynamicCap ? 'warning' : 'success');
            } catch (error) {
                displayResult(`âŒ é”™è¯¯: ${error.message}\n\nè¯·ç¡®ä¿åç«¯æœåŠ¡å·²å¯åŠ¨ (python backend/main.py)`, 'error');
            }
        }

        // æµ‹è¯•æ¡ˆä¾‹2: 20ä¸‡å¹´è–ªï¼Œ1.2ä¸‡ç¼´è´¹
        async function testCase2() {
            displayResult('â³ æ­£åœ¨æµ‹è¯•...');
            try {
                const response = await fetch(`${API_BASE}/history/diagnose`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        history: [
                            { year: 2022, salary: 200000, contribution: 12000 },
                            { year: 2023, salary: 200000, contribution: 12000 },
                            { year: 2024, salary: 200000, contribution: 12000 }
                        ],
                        age: 27
                    })
                });

                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                
                let output = 'âœ… æµ‹è¯•æ¡ˆä¾‹2: 20ä¸‡å¹´è–ª + 1.2ä¸‡ç¼´è´¹\n\n';
                output += `  ç´¯ç§¯T2: ${data.cumulativeT2}%\n`;
                output += `  æ¨èç¼´è´¹é¢: Â¥${data.recommendedAmount.toLocaleString()}/å¹´\n`;
                output += `  è¶…å‡ºåŠ¨æ€ä¸Šé™: ${data.diagnosis.exceedsDynamicCap ? 'æ˜¯' : 'å¦'}\n\n`;
                output += `  é¢„æœŸ: æ¨èé‡‘é¢åº”çº¦ä¸º 16,000-17,000ï¼ˆ0.08Ã—200kï¼‰\n`;
                output += `  å®é™…: Â¥${data.recommendedAmount.toLocaleString()}`;
                
                displayResult(output, 'success');
            } catch (error) {
                displayResult(`âŒ é”™è¯¯: ${error.message}`, 'error');
            }
        }

        // æµ‹è¯•æ¡ˆä¾‹3: è¶…é™ç¼´è´¹
        async function testCase3() {
            displayResult('â³ æ­£åœ¨æµ‹è¯•...');
            try {
                const response = await fetch(`${API_BASE}/history/diagnose`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        history: [
                            { year: 2024, salary: 240000, contribution: 30000 }
                        ],
                        age: 30
                    })
                });

                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                
                let output = 'âš ï¸ æµ‹è¯•æ¡ˆä¾‹3: 24ä¸‡å¹´è–ª + 3ä¸‡ç¼´è´¹ï¼ˆè¶…é™æµ‹è¯•ï¼‰\n\n';
                output += `  è¶…å‡ºåŠ¨æ€ä¸Šé™: ${data.diagnosis.exceedsDynamicCap ? 'æ˜¯ âœ…' : 'å¦ âŒ'}\n\n`;
                
                if (data.diagnosis.exceedsDynamicCap && data.diagnosis.capWarnings.length > 0) {
                    const w = data.diagnosis.capWarnings[0];
                    output += `  ç¼´è´¹é‡‘é¢: Â¥${w.contribution.toLocaleString()}\n`;
                    output += `  åŠ¨æ€ä¸Šé™: Â¥${w.dynamic_cap.toLocaleString()}\n`;
                    output += `  è¶…å‡ºé‡‘é¢: Â¥${w.excess.toLocaleString()}\n\n`;
                    output += `  âœ… ç³»ç»Ÿæ­£ç¡®æ£€æµ‹åˆ°è¶…é™ï¼`;
                } else {
                    output += `  âŒ æœªèƒ½æ£€æµ‹åˆ°è¶…é™ï¼Œå¯èƒ½æœ‰é—®é¢˜`;
                }
                
                displayResult(output, data.diagnosis.exceedsDynamicCap ? 'success' : 'error');
            } catch (error) {
                displayResult(`âŒ é”™è¯¯: ${error.message}`, 'error');
            }
        }

        // æµ‹è¯•æ¡ˆä¾‹4: ç›´æ¥è°ƒç”¨ä¸Šé™è®¡ç®—å™¨API
        async function testCapCalculator() {
            displayResult('â³ æ­£åœ¨æµ‹è¯•...');
            try {
                const testCases = [
                    { salary: 240000, t2: 20, desc: '24ä¸‡å¹´è–ª + T2=20%' },
                    { salary: 200000, t2: 13, desc: '20ä¸‡å¹´è–ª + T2=13%' },
                    { salary: 100000, t2: 8, desc: '10ä¸‡å¹´è–ª + T2=8%' },
                ];

                let output = 'ğŸ“Š åŠ¨æ€ä¸Šé™è®¡ç®—å™¨æµ‹è¯•\n\n';
                
                for (const tc of testCases) {
                    const response = await fetch(
                        `${API_BASE}/cap/calculate?annual_salary=${tc.salary}&t2_rate=${tc.t2}`
                    );
                    
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    const data = await response.json();
                    
                    output += `ã€${tc.desc}ã€‘\n`;
                    output += `  åŠ¨æ€ä¸Šé™ (0.08Ã—w): Â¥${data.details.dynamicCap.toLocaleString()}\n`;
                    output += `  å›ºå®šä¸Šé™ (effective): Â¥${data.details.fixedEffective.toLocaleString()}\n`;
                    output += `  æœ€ç»ˆä¸Šé™: Â¥${data.cap.toLocaleString()}\n`;
                    output += `  é€‰ç”¨é€šé“: ${data.details.usedChannel}\n`;
                    output += `  å…¬å¼: ${data.formula}\n\n`;
                }
                
                output += 'âœ… æ‰€æœ‰åœºæ™¯å‡ä½¿ç”¨dynamicé€šé“ï¼ˆé«˜æ”¶å…¥æƒ…å†µä¸‹ï¼‰';
                
                displayResult(output, 'success');
            } catch (error) {
                displayResult(`âŒ é”™è¯¯: ${error.message}`, 'error');
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºè¯´æ˜
        window.addEventListener('load', () => {
            displayResult(
                'ğŸ’¡ ä½¿ç”¨è¯´æ˜ï¼š\n\n' +
                '1. ç¡®ä¿åç«¯æœåŠ¡å·²å¯åŠ¨: cd backend && python main.py\n' +
                '2. ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®è¿è¡Œä¸åŒæµ‹è¯•æ¡ˆä¾‹\n' +
                '3. éªŒè¯åŠ¨æ€ä¸Šé™æ¨¡å‹æ˜¯å¦æ­£ç¡®æ›¿ä»£å›ºå®š12,000\n\n' +
                'å…³é”®é¢„æœŸï¼š\n' +
                '  â€¢ 24ä¸‡å¹´è–ª + T2=20% â†’ ä¸Šé™çº¦ Â¥19,200ï¼ˆé12kï¼‰\n' +
                '  â€¢ 20ä¸‡å¹´è–ª + T2=13% â†’ ä¸Šé™çº¦ Â¥16,000ï¼ˆé12kï¼‰\n' +
                '  â€¢ ç”¨æˆ·ç¼´è´¹1.5ä¸‡åº”è¢«åˆ¤å®šä¸ºåˆç†ï¼ˆåœ¨19.2kä¸Šé™å†…ï¼‰',
                'info'
            );
        });
    </script>
</body>
</html>
