<template>
  <div class="input-form-page min-h-screen p-8">
    <div class="container max-w-4xl mx-auto">
      <!-- è¿”å›æŒ‰é’® -->
      <button @click="goBack" class="mb-6 text-white/70 hover:text-white flex items-center transition-colors">
        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
        </svg>
        è¿”å›é¦–é¡µ
      </button>

      <!-- é¡µé¢æ ‡é¢˜ -->
      <div class="text-center mb-8 fade-in">
        <h1 class="text-4xl font-bold mb-3 text-white">å·²å‚ä¸è€… - æ–¹æ¡ˆè¯Šæ–­</h1>
        <p class="text-white/70">è¯·æä¾›æ‚¨çš„å†å²ç¼´è´¹æ•°æ®ï¼ŒAIå°†è¯Šæ–­æ‚¨çš„ç¼´è´¹æ•ˆç‡</p>
      </div>

      <!-- è¡¨å•å¡ç‰‡ -->
      <div class="glass-card p-8 fade-in">
        <!-- æ•°æ®è¾“å…¥æ–¹å¼é€‰æ‹© -->
        <div class="mb-8">
          <h2 class="text-xl font-semibold mb-4 text-white">è¯·é€‰æ‹©æ•°æ®è¾“å…¥æ–¹å¼</h2>
          <div class="grid md:grid-cols-3 gap-4">
            <button
              @click="inputMethod = 'api'"
              :class="['p-4 rounded-lg border-2 transition-all', 
                       inputMethod === 'api' ? 'border-accent-purple bg-accent-purple/10' : 'border-white/20']"
            >
              <div class="text-center">
                <svg class="w-8 h-8 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                </svg>
                <div class="font-semibold">è‡ªåŠ¨å¯¹æ¥</div>
                <div class="text-xs text-white/60 mt-1">æˆæƒè¿æ¥å…»è€é‡‘å¹³å°API</div>
              </div>
            </button>
            
            <button
              @click="inputMethod = 'upload'"
              :class="['p-4 rounded-lg border-2 transition-all', 
                       inputMethod === 'upload' ? 'border-accent-purple bg-accent-purple/10' : 'border-white/20']"
            >
              <div class="text-center">
                <svg class="w-8 h-8 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
                <div class="font-semibold">ä¸Šä¼ æˆªå›¾</div>
                <div class="text-xs text-white/60 mt-1">å·¥èµ„/ç¨åŠ¡/äººç¤¾APPæˆªå›¾ï¼ˆOCRè¯†åˆ«ï¼‰</div>
              </div>
            </button>
            
            <button
              @click="inputMethod = 'manual'"
              :class="['p-4 rounded-lg border-2 transition-all', 
                       inputMethod === 'manual' ? 'border-accent-purple bg-accent-purple/10' : 'border-white/20']"
            >
              <div class="text-center">
                <svg class="w-8 h-8 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                </svg>
                <div class="font-semibold">æ‰‹åŠ¨å½•å…¥</div>
                <div class="text-xs text-white/60 mt-1">å¡«å†™è¿‘3å¹´æ”¶å…¥å’Œç¼´è´¹</div>
              </div>
            </button>
          </div>
        </div>

        <!-- æ¡ä»¶æ¸²æŸ“ä¸åŒè¾“å…¥è¡¨å• -->
        <!-- æ–¹å¼1: APIå¯¹æ¥ -->
        <div v-if="inputMethod === 'api'" class="mb-8">
          <div class="bg-blue-500/10 border border-blue-500/30 rounded-lg p-6">
            <h3 class="font-semibold text-white mb-4">æˆæƒè¿æ¥å…»è€é‡‘å¹³å°</h3>
            <p class="text-white/70 text-sm mb-4">
              ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ï¼Œå°†è·³è½¬åˆ°å…»è€é‡‘ç®¡ç†å¹³å°è¿›è¡Œèº«ä»½éªŒè¯ã€‚æˆæƒåç³»ç»Ÿå°†è‡ªåŠ¨è·å–æ‚¨çš„å†å²ç¼´è´¹è®°å½•ã€‚
            </p>
            <button class="btn-primary">
              <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
              </svg>
              æˆæƒè¿æ¥
            </button>
          </div>
        </div>

        <!-- æ–¹å¼2: ä¸Šä¼ æˆªå›¾ -->
        <div v-if="inputMethod === 'upload'" class="mb-8">
          <h3 class="font-semibold text-white mb-4">ä¸Šä¼ APPæˆªå›¾ï¼ˆæ”¯æŒOCRè‡ªåŠ¨è¯†åˆ«ï¼‰</h3>
          <div class="border-2 border-dashed border-white/30 rounded-lg p-8 text-center">
            <svg class="w-16 h-16 mx-auto mb-4 text-white/40" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
            </svg>
            <p class="text-white/70 mb-4">æ‹–æ‹½æ–‡ä»¶è‡³æ­¤æˆ–ç‚¹å‡»ä¸Šä¼ </p>
            <input
              type="file"
              multiple
              accept="image/*"
              @change="handleFileUpload"
              class="hidden"
              ref="fileInput"
            />
            <button @click="triggerFileUpload" class="btn-secondary">
              é€‰æ‹©æ–‡ä»¶
            </button>
            <p class="text-xs text-white/50 mt-4">æ”¯æŒæ ¼å¼: JPG, PNG (æœ€å¤š5å¼ )</p>
          </div>
          <div v-if="uploadedFiles.length > 0" class="mt-4">
            <div class="text-sm text-white/70 mb-2">å·²ä¸Šä¼  {{ uploadedFiles.length }} ä¸ªæ–‡ä»¶:</div>
            <div class="space-y-2">
              <div v-for="(file, index) in uploadedFiles" :key="index" 
                   class="flex items-center justify-between bg-white/5 rounded p-2">
                <span class="text-sm">{{ file.name }}</span>
                <button @click="removeFile(index)" class="text-red-400 hover:text-red-300">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                  </svg>
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- æ–¹å¼3: æ‰‹åŠ¨å½•å…¥ -->
        <div v-if="inputMethod === 'manual'">
          <!-- åŸºæœ¬ä¿¡æ¯ -->
          <h3 class="font-semibold text-white mb-4">åŸºæœ¬ä¿¡æ¯</h3>
          <div class="glass-card p-6 mb-6">
            <div class="grid md:grid-cols-3 gap-4">
              <div>
                <label class="block text-white/80 mb-2 text-sm">å½“å‰å¹´é¾„</label>
                <div class="relative">
                  <input
                    v-model.number="basicInfo.age"
                    type="number"
                    min="18"
                    max="60"
                    class="input-field pr-12"
                    placeholder="è¯·è¾“å…¥å¹´é¾„"
                  />
                  <span class="absolute right-4 top-1/2 -translate-y-1/2 text-white/50">å²</span>
                </div>
              </div>
              <div>
                <label class="block text-white/80 mb-2 text-sm">æ‰€å±è¡Œä¸š</label>
                <select v-model="basicInfo.industry" class="input-field">
                  <option value="">è¯·é€‰æ‹©</option>
                  <option value="it">äº’è”ç½‘/IT</option>
                  <option value="finance">é‡‘è/ä¿é™©</option>
                  <option value="manufacturing">åˆ¶é€ ä¸š</option>
                  <option value="education">æ•™è‚²/åŸ¹è®­</option>
                  <option value="healthcare">åŒ»ç–—/å¥åº·</option>
                  <option value="retail">é›¶å”®/è´¸æ˜“</option>
                  <option value="construction">å»ºç­‘/æˆ¿åœ°äº§</option>
                  <option value="service">æœåŠ¡ä¸š</option>
                  <option value="government">æ”¿åºœ/äº‹ä¸šå•ä½</option>
                  <option value="other">å…¶ä»–</option>
                </select>
              </div>
              <div>
                <label class="block text-white/80 mb-2 text-sm">èŒçº§/èŒä½</label>
                <select v-model="basicInfo.jobLevel" class="input-field">
                  <option value="">è¯·é€‰æ‹©</option>
                  <option value="entry">åˆçº§ï¼ˆ1-3å¹´ï¼‰</option>
                  <option value="intermediate">ä¸­çº§ï¼ˆ3-5å¹´ï¼‰</option>
                  <option value="senior">é«˜çº§ï¼ˆ5-10å¹´ï¼‰</option>
                  <option value="expert">ä¸“å®¶çº§ï¼ˆ10å¹´ä»¥ä¸Šï¼‰</option>
                  <option value="manager">ç®¡ç†å²—</option>
                </select>
              </div>
            </div>
          </div>
          
          <h3 class="font-semibold text-white mb-4">è¿‘3å¹´æ”¶å…¥ä¸ç¼´è´¹è®°å½•</h3>
          <div class="space-y-6">
            <div v-for="year in years" :key="year" class="glass-card p-6">
              <h4 class="text-lg font-semibold text-white mb-4">{{ year }}å¹´</h4>
              <div class="grid md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-white/80 mb-2 text-sm">å¹´è–ªï¼ˆç¨å‰ï¼‰</label>
                  <div class="relative">
                    <input
                      v-model.number="manualData[year].salary"
                      type="number"
                      min="0"
                      class="input-field pr-12"
                      placeholder="è¯·è¾“å…¥å¹´è–ª"
                    />
                    <span class="absolute right-4 top-1/2 -translate-y-1/2 text-white/50">å…ƒ</span>
                  </div>
                </div>
                <div>
                  <label class="block text-white/80 mb-2 text-sm">ä¸ªäººå…»è€é‡‘ç¼´è´¹é¢</label>
                  <div class="relative">
                    <input
                      v-model.number="manualData[year].contribution"
                      type="number"
                      min="0"
                      class="input-field pr-12"
                      placeholder="è¯·è¾“å…¥ç¼´è´¹é¢"
                    />
                    <span class="absolute right-4 top-1/2 -translate-y-1/2 text-white/50">å…ƒ</span>
                  </div>
                  <p class="text-white/60 text-xs mt-1">
                    ğŸ’¡ æç¤ºï¼šç¼´è´¹ä¸Šé™æ ¹æ®æ‚¨çš„å¹´è–ªå’ŒT2åŠ¨æ€è®¡ç®—ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨éªŒè¯
                  </p>
                  <p v-if="manualData[year].contribution && manualData[year].contribution! < 0" 
                     class="text-red-400 text-xs mt-1">
                    âš ï¸ ç¼´è´¹é¢ä¸èƒ½ä¸ºè´Ÿæ•°
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- æäº¤æŒ‰é’® -->
        <div v-if="inputMethod" class="flex justify-center mt-8 gap-4">
          <!-- æµ‹è¯•æ•°æ®å¿«é€Ÿå¡«å……æŒ‰é’® -->
          <button 
            v-if="inputMethod === 'manual'"
            @click="fillTestData" 
            class="px-6 py-3 rounded-lg bg-blue-500/20 border border-blue-400/50 text-blue-300 hover:bg-blue-500/30 transition-colors"
          >
            ğŸ§ª å¡«å……æµ‹è¯•æ•°æ®
          </button>
          
          <button @click="handleSubmit" class="btn-primary text-lg px-12" :disabled="!canSubmit">
            <span v-if="!isSubmitting">å¼€å§‹è¯Šæ–­åˆ†æ</span>
            <span v-else>åˆ†æä¸­...</span>
          </button>
        </div>
      </div>

      <!-- åº•éƒ¨æç¤º -->
      <div class="text-center mt-6 text-white/50 text-sm fade-in">
        <p>æ‚¨çš„æ•°æ®å°†è¢«åŠ å¯†å­˜å‚¨ï¼Œä»…ç”¨äºè¯Šæ–­è®¡ç®—ï¼Œä¸ä¼šæ³„éœ²ç»™ç¬¬ä¸‰æ–¹</p>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, computed } from 'vue'
import { useRouter } from 'vue-router'

const router = useRouter()

type InputMethod = 'api' | 'upload' | 'manual' | null

const inputMethod = ref<InputMethod>(null)
const fileInput = ref<HTMLInputElement | null>(null)
const uploadedFiles = ref<File[]>([])
const isSubmitting = ref(false)

// åŸºæœ¬ä¿¡æ¯ï¼ˆç”¨äºAIé¢„æµ‹ï¼‰
const basicInfo = ref({
  age: null as number | null,
  industry: '',
  jobLevel: ''
})

const years = [2022, 2023, 2024]
const manualData = ref<Record<number, { salary: number | null; contribution: number | null }>>({
  2022: { salary: null, contribution: null },
  2023: { salary: null, contribution: null },
  2024: { salary: null, contribution: null }
})

// æµ‹è¯•æ•°æ®å¡«å……å‡½æ•°
const fillTestData = () => {
  basicInfo.value.age = 27
  basicInfo.value.industry = 'finance'
  basicInfo.value.jobLevel = 'intermediate'
  manualData.value[2022] = { salary: 200000, contribution: 12000 }
  manualData.value[2023] = { salary: 210000, contribution: 13000 }
  manualData.value[2024] = { salary: 220000, contribution: 15000 }
  console.log('âœ… æµ‹è¯•æ•°æ®å·²å¡«å……')
}

const canSubmit = computed(() => {
  if (inputMethod.value === 'upload') {
    return uploadedFiles.value.length > 0
  } else if (inputMethod.value === 'manual') {
    // æ£€æŸ¥åŸºæœ¬ä¿¡æ¯æ˜¯å¦å®Œæ•´
    const hasBasicInfo = basicInfo.value.age !== null && 
                         basicInfo.value.industry !== '' && 
                         basicInfo.value.jobLevel !== ''
    // æ£€æŸ¥å†å²æ•°æ®æ˜¯å¦å®Œæ•´
    const hasHistoryData = years.every(year => 
      manualData.value[year].salary !== null && 
      manualData.value[year].contribution !== null
    )
    return hasBasicInfo && hasHistoryData
  } else if (inputMethod.value === 'api') {
    // APIæ–¹å¼éœ€è¦å®Œæˆæˆæƒï¼ˆè¿™é‡Œç®€åŒ–å¤„ç†ï¼‰
    return true
  }
  return false
})

const goBack = () => {
  router.push('/')
}

const triggerFileUpload = () => {
  fileInput.value?.click()
}

const handleFileUpload = (event: Event) => {
  const target = event.target as HTMLInputElement
  if (target.files) {
    const newFiles = Array.from(target.files).slice(0, 5)
    uploadedFiles.value = newFiles
  }
}

const removeFile = (index: number) => {
  uploadedFiles.value.splice(index, 1)
}

const handleSubmit = async () => {
  if (!canSubmit.value) return
  
  isSubmitting.value = true
  
  try {
    let wageGrowthRate = 0.05 // é»˜è®¤5%
    let currentSalary = 0
    
    if (inputMethod.value === 'manual') {
      // è®¡ç®—æœ€æ–°å¹´ä»½çš„å¹´è–ªï¼ˆä½œä¸ºå½“å‰å¹´è–ªï¼‰
      const latestYear = Math.max(...years)
      currentSalary = manualData.value[latestYear].salary || 0
      
      // è°ƒç”¨AIå·¥èµ„å¢é•¿ç‡é¢„æµ‹API
      try {
        const response = await fetch('http://localhost:8000/api/predict-wage-growth', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            age: basicInfo.value.age,
            annualSalary: currentSalary,
            industry: basicInfo.value.industry,
            jobLevel: basicInfo.value.jobLevel
          })
        })
        
        if (response.ok) {
          const result = await response.json()
          // predictedGrowthæ˜¯ç™¾åˆ†æ¯”æ•°å€¼ï¼ˆå¦‚5.2è¡¨ç¤º5.2%ï¼‰ï¼Œéœ€è½¬æ¢ä¸ºå°æ•°ï¼ˆ0.052ï¼‰
          wageGrowthRate = (result.predictedGrowth || 5.0) / 100.0
          console.log('âœ… AIé¢„æµ‹å·¥èµ„å¢é•¿ç‡:', result.predictedGrowth + '%')
        } else {
          console.warn('âš ï¸ AIé¢„æµ‹å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å¢é•¿ç‡5%')
        }
      } catch (error) {
        console.warn('âš ï¸ AIé¢„æµ‹APIè°ƒç”¨å‡ºé”™ï¼Œä½¿ç”¨é»˜è®¤å¢é•¿ç‡5%:', error)
      }
    }
    
    // è·³è½¬åˆ°æŠ¥å‘Šé¡µé¢ï¼Œä¼ é€’æ•°æ®
    router.push({
      name: 'PathBReport',
      query: {
        method: inputMethod.value || 'manual',
        age: String(basicInfo.value.age || 30),
        industry: basicInfo.value.industry || 'other',
        jobLevel: basicInfo.value.jobLevel || 'intermediate',
        wageGrowthRate: String(wageGrowthRate),
        currentSalary: String(currentSalary),
        // ä¼ é€’å†å²æ•°æ®
        historyData: JSON.stringify(manualData.value)
      }
    })
  } catch (error) {
    console.error('æäº¤å¤±è´¥:', error)
    alert('æäº¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•')
  } finally {
    isSubmitting.value = false
  }
}
</script>

<style scoped>
.input-form-page {
  background: linear-gradient(135deg, #2C2A4A 0%, #1A3A52 100%);
  min-height: 100vh;
}

button:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}
</style>
